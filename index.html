<!DOCTYPE html>
<html>
<head>
  <title>Google Quiz Live</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --google-blue: #4285F4;
      --google-red: #EA4335;
      --google-yellow: #FBBC05;
      --google-green: #34A853;
      
      --dark-bg: #202124;
      --card-bg: #292a2d;
      --text-color: #E8EAED;
      --border-radius: 16px;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 25% 25%, rgba(66, 133, 244, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 75% 75%, rgba(52, 168, 83, 0.1) 0%, transparent 50%);
      pointer-events: none;
    }

    .container {
      width: 100%;
      max-width: 700px;
      padding: 40px;
      text-align: center;
      background: rgba(41, 42, 45, 0.95);
      border-radius: var(--border-radius);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }
    
    .logo {
        width: 120px;
        margin-bottom: 20px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }

    h1, h2 {
      font-weight: 500;
      color: var(--google-blue);
      margin-top: 0;
      margin-bottom: 20px;
    }
    
    h1 { 
      font-weight: 700; 
      font-size: 2.5em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    h2 { font-weight: 500; }
    
    #connection-status {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    #connection-status.connected {
      background-color: rgba(52, 168, 83, 0.2);
      color: var(--google-green);
    }
    
    #connection-status.disconnected {
      background-color: rgba(234, 67, 53, 0.2);
      color: var(--google-red);
    }
    
    #timer-display {
      font-size: 4em;
      font-weight: 700;
      color: var(--google-yellow);
      margin-top: -10px;
      margin-bottom: 30px;
      transition: color 0.5s, transform 0.3s;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    #timer-display.low-time {
      color: var(--google-red);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    #registration-container {
      margin-bottom: 30px;
    }

    #username-input {
      padding: 15px 20px;
      width: 70%;
      max-width: 300px;
      border: 2px solid #5F6368;
      background-color: rgba(60, 64, 67, 0.3);
      border-radius: 12px;
      color: var(--text-color);
      font-size: 16px;
      transition: border-color 0.3s, background-color 0.3s;
      margin-bottom: 15px;
    }

    #username-input:focus {
      outline: none;
      border-color: var(--google-blue);
      background-color: rgba(60, 64, 67, 0.5);
    }

    .btn {
      padding: 15px 30px;
      border: none;
      background: linear-gradient(135deg, var(--google-blue) 0%, #6a9cfd 100%);
      color: var(--text-color);
      font-size: 16px;
      font-weight: 500;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }
    
    .btn:active {
      transform: translateY(0);
    }

    #quiz-container {
      display: none;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    #question-text {
      font-size: 26px;
      font-weight: 500;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 0 30px 0;
      line-height: 1.4;
    }

    #options-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .option-button {
      background: linear-gradient(135deg, #3C4043 0%, #5F6368 100%);
      border: 2px solid transparent;
      color: var(--text-color);
      font-size: 16px;
      font-weight: 500;
      padding: 18px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .option-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .option-button:hover:not([disabled])::before {
      left: 100%;
    }

    .option-button:hover:not([disabled]) {
      background: linear-gradient(135deg, #5F6368 0%, #80868B 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .option-button:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }

    .option-button.correct {
        background: linear-gradient(135deg, var(--google-green) 0%, #4CAF50 100%);
        border: 2px solid var(--google-green);
        box-shadow: 0 4px 15px rgba(52, 168, 83, 0.3);
    }
    
    .option-button.incorrect {
        background: linear-gradient(135deg, var(--google-red) 0%, #F44336 100%);
        border: 2px solid var(--google-red);
        box-shadow: 0 4px 15px rgba(234, 67, 53, 0.3);
    }

    #leaderboard {
      width: 100%;
    }

    #leaderboard-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #leaderboard-list li {
      background: linear-gradient(135deg, var(--dark-bg) 0%, #2d2e31 100%);
      padding: 18px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: transform 0.2s;
    }
    
    #leaderboard-list li:hover {
      transform: translateY(-1px);
    }
    
    #leaderboard-list li:nth-child(1) { 
      color: var(--google-blue); 
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.2);
    }
    #leaderboard-list li:nth-child(2) { 
      color: var(--google-green); 
      box-shadow: 0 4px 15px rgba(52, 168, 83, 0.2);
    }
    #leaderboard-list li:nth-child(3) { 
      color: var(--google-yellow); 
      box-shadow: 0 4px 15px rgba(251, 188, 5, 0.2);
    }

    .waiting-message {
      font-size: 18px;
      color: var(--google-yellow);
      margin-top: 20px;
      animation: fadeInOut 2s infinite;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

  </style>
</head>
<body>
  <div class="container">
    <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google Logo" class="logo">
    <h1>Google GDG Live Quiz</h1>
    
    <div id="connection-status" class="disconnected">Connecting to server...</div>

    <div id="registration-container">
      <input type="text" id="username-input" placeholder="Enter your name to join">
      <br>
      <button id="register-button" class="btn">Join the Quiz</button>
    </div>

    <div id="quiz-container">
      <div id="timer-display">15</div>
      <h2 id="question-text"></h2>
      <div id="options-container">
      </div>
    </div>
    
    <h2 id="leaderboard-title">Live Leaderboard</h2>
    <div id="leaderboard">
      <ul id="leaderboard-list">
      </ul>
    </div>
  </div>
  
  <script>
    // Fallback quiz questions for demo/offline mode
    const fallbackQuestions = [
      {
        question: "What was Google's original name?",
        options: ["SearchEngine", "BackRub", "Googolplex", "The Answer"],
        answer: "BackRub"
      },
      {
        question: "What year was Google founded?",
        options: ["1996", "1998", "2000", "2004"],
        answer: "1998"
      },
      {
        question: "What is the name of Google's operating system for mobile devices?",
        options: ["Chrome OS", "Android", "Google Phone OS", "Flutter"],
        answer: "Android"
      },
      {
        question: "Who co-founded Google with Larry Page?",
        options: ["Elon Musk", "Steve Wozniak", "Sergey Brin", "Bill Gates"],
        answer: "Sergey Brin"
      },
      {
        question: "What is the name of the company that owns Google?",
        options: ["Alphabet Inc.", "Microsoft", "Meta", "Google X"],
        answer: "Alphabet Inc."
      }
    ];

    // DOM elements
    const registrationContainer = document.getElementById('registration-container');
    const registerButton = document.getElementById('register-button');
    const usernameInput = document.getElementById('username-input');
    const leaderboardList = document.getElementById('leaderboard-list');
    const quizContainer = document.getElementById('quiz-container');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const leaderboardTitle = document.getElementById('leaderboard-title');
    const timerDisplay = document.getElementById('timer-display');
    const connectionStatus = document.getElementById('connection-status');

    // Quiz state
    let currentUser = null;
    let users = [];
    let socket = null;
    let isConnected = false;
    let currentQuestionIndex = 0;
    let quizStarted = false;
    let offlineMode = false;

    // Initialize connection
    function initializeConnection() {
      try {
        socket = io("https://gdg-on-campus-quiz.onrender.com", {
          timeout: 5000,
          forceNew: true
        });

        socket.on('connect', () => {
          console.log('Connected to server');
          isConnected = true;
          connectionStatus.textContent = 'Connected to server';
          connectionStatus.className = 'connected';
        });

        socket.on('disconnect', () => {
          console.log('Disconnected from server');
          isConnected = false;
          connectionStatus.textContent = 'Disconnected from server - Running in demo mode';
          connectionStatus.className = 'disconnected';
          if (!offlineMode) {
            startOfflineMode();
          }
        });

        socket.on('connect_error', (error) => {
          console.error('Connection error:', error);
          connectionStatus.textContent = 'Connection failed - Running in demo mode';
          connectionStatus.className = 'disconnected';
          if (!offlineMode) {
            startOfflineMode();
          }
        });

        // Socket event listeners
        socket.on('timerUpdate', (timeLeft) => {
          updateTimer(timeLeft);
        });

        socket.on('newQuestion', (questionData) => {
          displayQuestion(questionData);
        });
        
        socket.on('answerResult', ({ isCorrect, correctAnswer }) => {
          showAnswerResult(isCorrect, correctAnswer);
        });

        socket.on('quizFinished', () => {
          endQuiz();
        });

        socket.on('updateLeaderboard', (serverUsers) => {
          updateLeaderboard(serverUsers);
        });

        // Timeout for connection
        setTimeout(() => {
          if (!isConnected && !offlineMode) {
            console.log('Connection timeout - starting offline mode');
            startOfflineMode();
          }
        }, 10000);

      } catch (error) {
        console.error('Failed to initialize socket connection:', error);
        startOfflineMode();
      }
    }

    function startOfflineMode() {
      offlineMode = true;
      connectionStatus.textContent = 'Demo Mode - Experience the quiz locally';
      connectionStatus.className = 'disconnected';
      
      // Add some demo users to leaderboard
      users = [
        { name: 'Demo Player 1', score: 30 },
        { name: 'Demo Player 2', score: 20 },
        { name: 'Demo Player 3', score: 10 }
      ];
      updateLeaderboard(users);
    }

    function updateTimer(timeLeft) {
      timerDisplay.textContent = timeLeft;
      if (timeLeft <= 5) {
        timerDisplay.classList.add('low-time');
      } else {
        timerDisplay.classList.remove('low-time');
      }
    }

    function displayQuestion(questionData) {
      questionText.textContent = `Question ${questionData.questionNumber}: ${questionData.question}`;
      optionsContainer.innerHTML = '';
      
      questionData.options.forEach(option => {
        const button = document.createElement('button');
        button.className = 'option-button';
        button.textContent = option;
        
        button.addEventListener('click', () => {
          handleAnswerClick(option);
        });
        
        optionsContainer.appendChild(button);
      });
    }

    function handleAnswerClick(answer) {
      // Disable all buttons
      Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
      
      if (isConnected && socket) {
        socket.emit('submitAnswer', answer);
      } else {
        // Offline mode - simulate answer checking
        const currentQuestion = fallbackQuestions[currentQuestionIndex];
        const isCorrect = answer === currentQuestion.answer;
        
        if (isCorrect && currentUser) {
          currentUser.score += 10;
          // Update user in users array
          const userIndex = users.findIndex(u => u.name === currentUser.name);
          if (userIndex >= 0) {
            users[userIndex] = currentUser;
          }
          updateLeaderboard(users);
        }
        
        showAnswerResult(isCorrect, currentQuestion.answer);
        
        // Auto advance to next question after 2 seconds
        setTimeout(() => {
          currentQuestionIndex++;
          if (currentQuestionIndex < fallbackQuestions.length) {
            displayOfflineQuestion();
          } else {
            endQuiz();
          }
        }, 2000);
      }
    }

    function showAnswerResult(isCorrect, correctAnswer) {
      const buttons = Array.from(optionsContainer.children);
      buttons.forEach(btn => {
        if (btn.textContent === correctAnswer) {
          btn.classList.add('correct');
        } else if (btn.disabled && btn.textContent !== correctAnswer) {
          btn.classList.add('incorrect');
        }
      });
    }

    function displayOfflineQuestion() {
      if (currentQuestionIndex < fallbackQuestions.length) {
        const questionData = {
          question: fallbackQuestions[currentQuestionIndex].question,
          options: fallbackQuestions[currentQuestionIndex].options,
          questionNumber: currentQuestionIndex + 1
        };
        
        displayQuestion(questionData);
        
        // Simulate timer
        let timeLeft = 15;
        updateTimer(timeLeft);
        const timerInterval = setInterval(() => {
          timeLeft--;
          updateTimer(timeLeft);
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            // Auto advance if no answer given
            if (!Array.from(optionsContainer.children).some(btn => btn.disabled)) {
              currentQuestionIndex++;
              if (currentQuestionIndex < fallbackQuestions.length) {
                setTimeout(() => displayOfflineQuestion(), 1000);
              } else {
                endQuiz();
              }
            }
          }
        }, 1000);
      }
    }

    function endQuiz() {
      questionText.textContent = "The quiz has ended! Final scores are below.";
      optionsContainer.innerHTML = '';
      leaderboardTitle.textContent = "Final Leaderboard";
      timerDisplay.style.display = 'none';
      quizStarted = false;
    }

    function updateLeaderboard(serverUsers) {
      leaderboardList.innerHTML = '';
      const sortedUsers = serverUsers.sort((a, b) => b.score - a.score);

      if (sortedUsers.length === 0) {
        const emptyItem = document.createElement('li');
        emptyItem.textContent = 'No players yet...';
        emptyItem.style.opacity = '0.6';
        leaderboardList.appendChild(emptyItem);
        return;
      }

      sortedUsers.forEach((user, index) => {
        const listItem = document.createElement('li');
        const position = index + 1;
        const medal = position === 1 ? 'ðŸ¥‡' : position === 2 ? 'ðŸ¥ˆ' : position === 3 ? 'ðŸ¥‰' : `${position}.`;
        listItem.textContent = `${medal} ${user.name}: ${user.score} points`;
        leaderboardList.appendChild(listItem);
      });
    }

    // Register button click handler
    registerButton.addEventListener('click', () => {
      const userName = usernameInput.value.trim();
      if (!userName) {
        alert('Please enter your name!');
        return;
      }

      currentUser = { name: userName, score: 0 };
      registrationContainer.style.display = 'none';
      quizContainer.style.display = 'block';
      leaderboardTitle.textContent = "Live Leaderboard";

      if (isConnected && socket) {
        console.log('Attempting to register user:', userName);
        socket.emit('register', userName);
      } else {
        // Offline mode
        users.push(currentUser);
        updateLeaderboard(users);
        
        if (!quizStarted) {
          quizStarted = true;
          questionText.textContent = "Get ready! The quiz will start in 3 seconds...";
          setTimeout(() => {
            currentQuestionIndex = 0;
            displayOfflineQuestion();
          }, 3000);
        }
      }
    });

    // Enter key support for username input
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        registerButton.click();
      }
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      initializeConnection();
    });

    // Load socket.io script dynamically with fallback
    const script = document.createElement('script');
    script.src = 'https://gdg-on-campus-quiz.onrender.com/socket.io/socket.io.js';
    script.onerror = () => {
      console.log('Failed to load socket.io - running in offline mode');
      startOfflineMode();
    };
    document.head.appendChild(script);
  </script>
</body>
</html>